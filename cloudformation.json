{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Kibana ECS task/service definition with ELB.",
  "Parameters": {
    "ImageRef": {
      "Type": "String",
      "Description": "Image to use",
      "Default": "scalawilliam/eventsource-hub:latest"
    }
  },
  "Resources": {
    "Cluster": {
      "Type": "AWS::ECS::Cluster"
    },
    "taskdefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ContainerDefinitions": [
          {
            "Memory": 256,
            "PortMappings": [
              {
                "HostPort": 9000,
                "ContainerPort": 9000,
                "Protocol": "tcp"
              }
            ],
            "Essential": true,
            "Name": "kibana",
            "Environment": [
              {
                "Name": "SERVER_SSLCERT",
                "Value": "/localhost.pem"
              },
              {
                "Name": "SERVER_SSLKEY",
                "Value": "/localhost-nopass.key"
              }
            ],
            "Image": {
              "Ref": "ImageRef"
            },
            "Cpu": 512
          }
        ],
        "Volumes": []
      }
    },
    "service": {
      "Type": "AWS::ECS::Service",
      "Properties": {
        "Cluster": {
          "Ref": "Cluster"
        },
        "DesiredCount": "1",
        "TaskDefinition": {
          "Ref": "taskdefinition"
        }
      }
    }
  },
  "Outputs": {
    "ecsservice": {
      "Value": {
        "Ref": "service"
      }
    },
    "taskdef": {
      "Value": {
        "Ref": "taskdefinition"
      }
    },
    "Name": {
      "Description": "Name of the service",
      "Value": {
        "Fn::GetAtt": [
          "service",
          "Name"
        ]
      }
    }
  }
}
